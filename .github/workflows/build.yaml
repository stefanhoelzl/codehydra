name: Build Distribution

on:
  workflow_call:
    inputs:
      release:
        description: "Use release versioning (YYYY.M.D or YYYY.M.D.N for same-day releases)"
        type: boolean
        default: false
    outputs:
      version:
        description: "The computed version string"
        value: ${{ jobs.prepare.outputs.version }}
      is_base_version:
        description: "Whether this is a base version (no .N suffix) for npm/PyPI"
        value: ${{ jobs.prepare.outputs.is_base_version }}

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_base_version: ${{ steps.version.outputs.is_base_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ inputs.release }}" == "true" ]]; then
            # Format: YYYY.M.D (no leading zeros)
            YEAR=$(date -u +%Y)
            MONTH=$(date -u +%-m)
            DAY=$(date -u +%-d)
            BASE_VERSION="${YEAR}.${MONTH}.${DAY}"

            # Check for existing releases with this date
            # Escape dots for regex matching
            BASE_PATTERN="${BASE_VERSION//./\\.}"
            EXISTING=$(gh release list --repo "${{ github.repository }}" --json tagName --jq '.[].tagName' 2>/dev/null | grep -E "^v${BASE_PATTERN}(\.[0-9]+)?$" || true)

            if [[ -z "$EXISTING" ]]; then
              # No existing release for today
              VERSION="$BASE_VERSION"
            else
              # Find highest suffix
              MAX_SUFFIX=0
              for TAG in $EXISTING; do
                if [[ "$TAG" == "v${BASE_VERSION}" ]]; then
                  # Base version exists, need at least .1
                  [[ $MAX_SUFFIX -lt 1 ]] && MAX_SUFFIX=1
                elif [[ "$TAG" =~ ^v${BASE_PATTERN}\.([0-9]+)$ ]]; then
                  SUFFIX="${BASH_REMATCH[1]}"
                  [[ $SUFFIX -ge $MAX_SUFFIX ]] && MAX_SUFFIX=$((SUFFIX + 1))
                fi
              done
              VERSION="${BASE_VERSION}.${MAX_SUFFIX}"
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT

            # Check if this is a base version (no .N suffix)
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "is_base_version=true" >> $GITHUB_OUTPUT
            else
              echo "is_base_version=false" >> $GITHUB_OUTPUT
            fi
          else
            DATE=$(git log -1 --format=%cd --date=format:'%Y.%-m.%-d')
            HASH=$(git rev-parse --short=8 HEAD)
            DIRTY=$(git status --porcelain | grep -q . && echo "-dirty" || echo "")
            echo "version=${DATE}-dev.${HASH}${DIRTY}" >> $GITHUB_OUTPUT
          fi

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build
        env:
          CODEHYDRA_VERSION: ${{ steps.version.outputs.version }}
          CODEHYDRA_RELEASE: ${{ inputs.release }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          POSTHOG_HOST: ${{ vars.POSTHOG_HOST }}
        run: pnpm build

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: out
          retention-days: 1

  package:
    name: Package (${{ matrix.artifact }})
    needs: prepare
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact: linux-x64
            target: linux:appimage
            output: CodeHydra-linux-x64.AppImage
          - artifact: win-installer-x64
            target: win:installer
            output: CodeHydra-win-installer-x64.exe
            wine: true
          - artifact: win-portable-x64
            target: win:portable
            output: win-unpacked
            rename: CodeHydra-win-portable-x64
            wine: true
          - artifact: darwin-x64
            target: mac:intel
            output: mac
            rename: CodeHydra-darwin-x64
            tar: true
          - artifact: darwin-arm64
            target: mac:arm
            output: mac-arm64
            rename: CodeHydra-darwin-arm64
            tar: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out

      - name: Install Wine
        if: matrix.wine
        timeout-minutes: 5
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wine64 wine32:i386

      - name: Package
        env:
          CODEHYDRA_VERSION: ${{ needs.prepare.outputs.version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          pnpm pkg set "version=$CODEHYDRA_VERSION"
          pnpm dist:${{ matrix.target }} -- --publish=never

      - name: Rename artifact
        if: matrix.rename
        run: mv dist/${{ matrix.output }} dist/${{ matrix.rename }}

      - name: Create tar archive
        if: matrix.tar
        run: |
          NAME="${{ matrix.rename || matrix.output }}"
          tar czf "dist/${NAME}.tar.gz" -C dist "$NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rename || matrix.output }}${{ matrix.tar && '.tar.gz' || '' }}
          path: dist/${{ matrix.rename || matrix.output }}${{ matrix.tar && '.tar.gz' || '' }}
          retention-days: 1
          if-no-files-found: error

      - name: Upload update metadata
        if: matrix.artifact == 'win-installer-x64' || matrix.artifact == 'linux-x64'
        uses: actions/upload-artifact@v4
        with:
          name: update-metadata-${{ matrix.artifact }}
          path: dist/latest*.yml
          retention-days: 1
          if-no-files-found: warn
